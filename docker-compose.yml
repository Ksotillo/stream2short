services:
  # Caddy - Reverse proxy with automatic HTTPS (on different ports)
  caddy:
    image: caddy:2-alpine
    container_name: stream2short-caddy
    ports:
      - "3080:80"        # API HTTP
      - "3443:443"       # API HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
    restart: unless-stopped

  # Redis - Queue broker
  redis:
    image: redis:7-alpine
    container_name: stream2short-redis
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Fastify API
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: stream2short-api
    expose:
      - "3000"
    environment:
      - API_PORT=3000
      - BASE_URL=${BASE_URL}
      - SE_SHARED_SECRET=${SE_SHARED_SECRET}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
      - TWITCH_REDIRECT_URI=${TWITCH_REDIRECT_URI}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REDIS_URL=redis://redis:6379/0
      # Dashboard auth
      - DASHBOARD_API_KEY=${DASHBOARD_API_KEY}
      - PUBLIC_DASHBOARD_URL=${PUBLIC_DASHBOARD_URL}
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Python Worker
  worker:
    build:
      context: ./apps/worker
      dockerfile: Dockerfile
    container_name: stream2short-worker
    environment:
      - REDIS_URL=redis://redis:6379/0
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - TWITCH_CLIENT_ID=${TWITCH_CLIENT_ID}
      - TWITCH_CLIENT_SECRET=${TWITCH_CLIENT_SECRET}
      - GOOGLE_SERVICE_ACCOUNT_FILE=/app/credentials/service-account.json
      - GOOGLE_SERVICE_ACCOUNT_JSON=${GOOGLE_SERVICE_ACCOUNT_JSON}
      # Shared Drive settings (required for service accounts)
      - GDRIVE_SHARED_DRIVE_ID=${GDRIVE_SHARED_DRIVE_ID}
      - GDRIVE_PARENT_FOLDER_ID=${GDRIVE_PARENT_FOLDER_ID}
      - GDRIVE_PARENT_FOLDER_NAME=${GDRIVE_PARENT_FOLDER_NAME:-Stream2Short Uploads}
      - WHISPER_MODEL=${WHISPER_MODEL:-small}
      - MAX_ATTEMPTS=${MAX_ATTEMPTS:-2}
      - CLEANUP_TEMP=${CLEANUP_TEMP:-false}
      # Speaker diarization (optional - requires HF token and model access)
      - HF_TOKEN=${HF_TOKEN}
      - ENABLE_DIARIZATION=${ENABLE_DIARIZATION:-false}
      - DIARIZATION_MODEL=${DIARIZATION_MODEL:-pyannote/speaker-diarization-3.1}
      - PRIMARY_SPEAKER_STRATEGY=${PRIMARY_SPEAKER_STRATEGY:-most_time}
    volumes:
      - worker_temp:/tmp/stream2short
      - ./credentials:/app/credentials:ro
      - huggingface_cache:/root/.cache/huggingface
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

volumes:
  redis_data:
  worker_temp:
  caddy_data:
  caddy_config:
  huggingface_cache:  # Cache for HuggingFace models (diarization)